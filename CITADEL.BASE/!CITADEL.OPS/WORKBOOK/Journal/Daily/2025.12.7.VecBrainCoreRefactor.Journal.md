///▙▖▙▖▞▞▙▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂
▛//▞▞ ⟦⎊⟧ :: ⧗-25.121 // JOURNAL :: brains-3ox-core Architecture Refactor ▞▞

▛▞ brains-3ox-core Architecture Refactor ::

[Description]
Refactor 3OX brain architecture to use shared core library (`brains-3ox-core`) with `brains.rs` as thin wrapper. Core lives in vault (master), `brains.rs` stays as required face but links to core library. Goal: one core brain, `brains.rs` compiles to `_runtime/3ox/rc/brains.exe` as before.

**Problem Statement:**
- Current brains.rs is monolithic with all logic embedded
- Need to avoid compiling dozens of heavy binaries
- Want protected core that can't be accidentally modified
- Need efficient agent creation without full recompilation
- Current structure mixes core logic with agent-specific code

**Solution Approach:**
Minimal refactor to library crate architecture:
- `brains-3ox-core` as shared library crate (master in vault)
- `brains.rs` stays as required face, becomes thin wrapper linking to core (package: `brains-3ox`)
- `brains.rs` compiles to `_runtime/3ox/rc/brains.exe` (existing pattern maintained)
- Static linking (Option A) - core compiled into binary as .rlib
- Runtime location: `_runtime/3ox/rc/` (workspace-level, allows future 3OX components)

**Architecture Decisions:**
- **Directory name:** `vec3.core` (with dot - file system naming)
- **Core crate name:** `brains-3ox-core` (with dash - Rust naming)
- **Wrapper package name:** `brains-3ox` (with dash - Rust naming)
- **Concept name:** `vec.brain.core` (mental model)
- **vec3:** Geometry binder module, not crate name
- **File names:** Use dots (e.g., `face.map.toml`, `manifest.vec3.toml`)
- **Vault (master):** `7HE.VAULT/3OX.Ai/vec3.core/` - source code with `src/` directory (directory name with dot, crate name brains-3ox-core)
- **Base (instance):** `CITADEL.BASE/!WORKDESK/AGENTS/{agent}/.3ox/` - `brains.rs` stays here (package: brains-3ox)
- **Runtime:** `_runtime/3ox/rc/` - compiled `brains.exe` (workspace-level, allows future 3OX components)
- **Protection:** Core versioned in vault, `brains.rs` can mutate
- **6 Required Faces:** Must stay (brains.rs, run.rb, tools.yml, routes.json, limits.toml, 3ox.log)

**Implementation Progress:**

**1. Create 3OX.Ai in Vault**
- [x] Create `7HE.VAULT/3OX.Ai/` directory
- [x] Move `vec3.core/` → `7HE.VAULT/3OX.Ai/vec3.core/` (directory name keeps dot)
- [x] Keep existing files (face.map.toml, manifest.vec3.toml, sparkfile.md, agent.id, build.sh)

**2. Refactor to Library Crate**
- [x] Convert `Cargo.toml` from binary to library crate (crate name: brains-3ox-core)
- [x] Create `src/` directory (only core needs this)
- [x] Convert `vec3.lib.rs` → `src/vec3.rs` (implement bind_cube)
- [x] Create `src/lib.rs` with core logic from `brains.rs` (cube loading, logging, session, tool execution)
- [x] Expose public API (init_brain, etc.) for `brains.rs` to call

**3. Update brains.rs to Link to Core**
- [x] Update `brains.rs` to depend on `brains-3ox-core` library (path: vec3.core)
- [x] Refactor `brains.rs` to call core library functions instead of containing all logic
- [x] Keep `main()` in `brains.rs` (required face)
- [x] Ensure `brains.rs` still compiles to `_runtime/3ox/rc/brains.exe` (existing pattern)

**4. Build and Deploy**
- [ ] Build `brains.rs`: `cargo build --release`
- [ ] Verify output: `_runtime/3ox/rc/brains.exe` (workspace-level runtime)
- [ ] Verify static linking (core compiled into binary)

**5. Update Paths and References**
- [x] Update `brains.rs` to reference `brains-3ox-core` from vault
- [ ] Update build scripts if needed
- [x] Update documentation (journal and notepad updated)

**Key Files Created/Modified:**

**Vault (Master):**
- `7HE.VAULT/3OX.Ai/vec3.core/Cargo.toml` - Convert to library (crate name: brains-3ox-core)
- `7HE.VAULT/3OX.Ai/vec3.core/src/lib.rs` - Core logic (from brains.rs)
- `7HE.VAULT/3OX.Ai/vec3.core/src/vec3.rs` - Geometry engine (from vec3.lib.rs)

**Base (Instance):**
- `CITADEL.BASE/!WORKDESK/AGENTS/{agent}/.3ox/brains.rs` - Thin wrapper linking to core (modified)
- `CITADEL.BASE/!WORKDESK/AGENTS/{agent}/.3ox/Cargo.toml` - Add dependency on brains-3ox-core

**Runtime:**
- `_runtime/3ox/rc/brains.exe` - Compiled binary (workspace-level runtime folder)

**Existing Files to Keep (All 6 Required Faces):**
- `brains.rs` - Required face (modified to link to core)
- `run.rb` - Required face
- `tools.yml` - Required face
- `routes.json` - Required face
- `limits.toml` - Required face
- `3ox.log` - Required face
- `face.map.toml` - Cube face declarations
- `manifest.vec3.toml` - Vec3 binding contract
- `sparkfile.md` - Core prompt
- `agent.id` - Agent identity
- `build.sh` - Build script

**Notes During Implementation:**
- File names use dots (e.g., `face.map.toml`), only Rust crate names use dashes
- Directory name: `vec3.core` (with dot), core crate name: `brains-3ox-core` (with dash)
- Wrapper package name: `brains-3ox` (with dash), binary name: `brains`
- Only `vec3.core/` needs `src/` directory (library crate structure, crate name brains-3ox-core)
- `brains.rs` stays in `.3ox/` as required face, compiles to `_runtime/3ox/rc/brains.exe` as before
- Minimal refactor: extract core logic to library, `brains.rs` becomes thin wrapper
- Option A (static linking) preferred - simpler, type-safe, no ABI concerns
- Core protection: version control + read-only deployment in vault
- `_runtime/3ox/rc/` allows future 3OX components to be compiled in same namespace
- Final naming: `brains-3ox-core` (library) and `brains-3ox` (wrapper package)

**Issues Encountered:**
- Rust package names cannot start with digits - used `brains-3ox` for package name (binary name remains `brains`)
- Rust package names cannot contain dots - used `brains-3ox-core` for crate name (directory name `vec3.core` keeps dot)
- Cargo path dependencies need absolute path or symlink - used absolute path to vault location
- serde_json needed in brains.rs Cargo.toml for JSON output formatting
- vec3.lib.rs needed to be moved to src/vec3.rs and recreated (was lost during move)

**Next Steps:**
- Build release binary and verify output at `_runtime/3ox/rc/brains.exe`
- Update build.sh script to use new structure
- Verify static linking (core compiled into binary)
- Update any documentation referencing old structure

:: ∎ //▚▚▂▂▂▂▂▂▂▂▂▂▂▂

